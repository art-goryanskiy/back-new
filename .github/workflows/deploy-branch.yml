# Ручной деплой выбранной ветки на сервер (для тестирования ветки на проде).
# Actions → Deploy branch → Run workflow → укажите ветку (например feature/xxx).

name: Deploy branch

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Ветка для деплоя на сервер'
        required: true
        default: 'main'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy branch to server
        env:
          SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          HOST: ${{ secrets.DEPLOY_HOST }}
          USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          BRANCH: ${{ inputs.branch }}
        run: |
          if [ -z "$SSH_KEY" ] || [ -z "$HOST" ] || [ -z "$USER" ]; then
            echo "Missing DEPLOY_SSH_KEY, DEPLOY_HOST or DEPLOY_USER secrets."
            exit 1
          fi
          DEPLOY_DIR="${DEPLOY_PATH:-$HOME/back-new}"
          echo "$SSH_KEY" > deploy_key.pem
          chmod 600 deploy_key.pem
          ssh -o StrictHostKeyChecking=accept-new -i deploy_key.pem "$USER@$HOST" \
            "cd $DEPLOY_DIR && git fetch origin && git checkout $BRANCH && git pull && docker compose build app && docker compose up -d app"
          rm -f deploy_key.pem
